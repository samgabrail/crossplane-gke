name: Destroy an APP with its repo

on:
  workflow_dispatch:
    inputs:
      apiName:
        description: 'API Name'
        required: true
      repoURLforArgo: 
        description: 'The URL of the repository to be destroyed'
        required: true

jobs:
  destroy-api:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Install Argo CD CLI
      run: |
        sudo curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
        sudo chmod +x /usr/local/bin/argocd

    - name: Login to Argo CD
      run: argocd login ${{ secrets.ARGOCD_SERVER }} --username ${{ secrets.ARGOCD_USER }} --password ${{ secrets.ARGOCD_PASS }} --grpc-web

    # - name: Destroy API
    #   run: |
    #       argocd app delete ${{ github.event.inputs.apiName }} --cascade --grpc-web -y

    - name: Destroy API
      id: delete_argocd_app
      run: |
        set +e  # Disable stopping the script on the first error
        argocd app delete withargo --cascade --grpc-web -y 2>&1 | tee delete_output.txt
        DELETE_APP_EXIT_CODE=${PIPESTATUS[0]}  # Capture the exit code of the argocd command
        if [ $DELETE_APP_EXIT_CODE -ne 0 ]; then
          if grep -q "permission denied" delete_output.txt; then
            echo "::error ::Permission denied when trying to delete the Argo CD application."
            exit $DELETE_APP_EXIT_CODE
          elif grep -q "not found" delete_output.txt; then
            echo "Application not found, considered as already deleted."
          else
            echo "::error ::Unexpected error when trying to delete the Argo CD application."
            cat delete_output.txt
            exit $DELETE_APP_EXIT_CODE
          fi
        fi
        set -e  # Re-enable stopping the script on errors

    - name: Extract and Construct Repo URL
      id: repo-url
      run: |
        query=${{ github.event.inputs.repoURLforArgo }}
        owner=$(echo $query | sed -n 's/.*owner=\([^&]*\).*/\1/p')
        repo=$(echo $query | sed -n 's/.*repo=\([^&]*\).*/\1/p')
        echo "Constructed URL: https://github.com/$owner/$repo.git"
        echo "::set-output name=url::https://github.com/$owner/$repo.git"
        echo "::set-output name=repo::$repo"
        
    - name: Unregister Repository from Argo CD
      run: argocd repo rm ${{ steps.repo-url.outputs.url }} --grpc-web -y

    - name: Delete GitHub Repository
      run: |
        echo "Deleting GitHub Repository ${{ steps.repo-url.outputs.repo }}"
        curl -X DELETE -H "Authorization: token ${{ secrets.MYGITHUB_TOKEN }}" \
        https://api.github.com/repos/${{ steps.repo-url.outputs.repo }}